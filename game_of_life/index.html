<html>
<head>
  <title>Game Of Life - Coronavirus Simulator</title>
  <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.1/p5.js"></script>
  <!-- uncomment lines below to include extra p5 libraries -->
  <script language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.1/addons/p5.dom.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
  <!--<script language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.1/addons/p5.sound.js"></script>-->
  <script language="javascript" type="text/javascript" src="simulationManager.js"></script>
  <script language="javascript" type="text/javascript" src="sketch.js"></script>
  <script language="javascript" type="text/javascript" src="population.js"></script>
  <script language="javascript" type="text/javascript" src="people.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script language="javascript" type="text/javascript" src="chart.js"></script>
  
  <link rel="stylesheet" type="text/css" href="gameoflifestyle.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
</head>
<body>
	<div class="container">
		<div class="row center spacer">
			<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
				<h1 class="center head"> Game Of Life - Coronavirus Simulator </h1>
				<h2 class="center title"> The following simulator shows coronavirus spreading over a population using the "game of life" model.</h2>
			</div>
		</div>
		<div class="row spacer" id="init_form">
			<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
				<form method="get" action="return false;">
				<div class="row">
					<div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="k_value_start" title="Isoulation factor">K value start</label>
							<input class="form-control" id="k_value_start" type="number" min="0" max="8"  placeholder="K value start" value="0" required>
						</div>
					</div>

					<div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="k_value_end">K value end</label>
							<input class="form-control" id="k_value_end" type="number" min="1" max="8"  placeholder="K value end" value="8" required>
						</div>
					</div>

					<div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="l_value" title="Number of generations with no isolation">L value</label>
							<input class="form-control" id="l_value" type="number" min="0" max="50"  placeholder="K value end" value="1" required>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="p_value_start" title="Infection chance">P value start %</label>
							<input class="form-control" id="p_value_start" type="number" min="1" max="100"  placeholder="P value start" value="100" required>
						</div>
					</div>

					<div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="p_value_step">P value step %</label>
							<input class="form-control" id="p_value_step" type="number" min="1" max="99"  placeholder="P value step"  value="10"  required>
						</div>
					</div>

					<div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="p_value_times">P value Times</label>
							<input class="form-control" id="p_value_times" type="number" min="1" max="100"  placeholder="P value Times"  value="9" required>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="pop_size_start">Population size start</label>
							<input class="form-control" id="pop_size_start" type="number" min="10" max="1000"  placeholder="Pop size start" value="500" required>
						</div>
					</div>

					<div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="pop_size_step">Population	 size step</label>
							<input class="form-control" id="pop_size_step" type="number" min="10" max="1000"  placeholder="Pop size step"  value="100" required>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="repeat_count">Repeat Runs</label>
							<input class="form-control" id="repeat_count" type="number" min="0" max="100"  placeholder="Repeat Runs" value="10" required>
						</div>
					</div>

					<div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="fps">Frames Per Second</label>
							<input class="form-control" id="fps" type="number" min="1" max="60"  placeholder="Frames Per Second" value="48" required>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="delay_mean" title="Average number of generations to die or recover">Mean recover \ dead generations</label>
							<input class="form-control" id="delay_mean" type="number" min="0" max="9999"  placeholder="Mean recover \ dead generations" value="9999" required>
						</div>
					</div>

					<div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="delay_spread" title="Standard deviation under uniform distribution">SD recover \ dead generations</label>
							<input class="form-control" id="delay_spread" type="number" min="1" max="50"  placeholder="Spread recover \ dead generations" value="5" required>
						</div>
					</div>

					<div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="recover_chance">Recovery Chance %</label>
							<input class="form-control" id="recover_chance" type="number" min="0" max="100"  placeholder="Recover Chance %" value="50" required>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="init_infected">Initial Infected</label>
							<input class="form-control" id="init_infected" type="number" min="1" max="500"  placeholder="Initial Infected" value="1" required>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
						<div class="form-group">
							<label for="grid_size">Grid Size</label>
							<input class="form-control" id="grid_size" type="number" min="10" max="250"  placeholder="Grid Size"  value="200" required>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
						<button class="btn btn-primary btn-lg" style="width: 100%; margin-top: 10px;" onclick="return startSimulation(true)">Run with graphic (cool)</button>
					</div>
					
					<div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
						<button class="btn btn-warning btn-lg" style="width: 100%; margin-top: 10px;" onclick="return startSimulation(false)">Run without graphic (fast)</button>
					</div>
				</div>
				
				</form>
			</div>
		</div>
		<div id="main" style="display: none">
			<div class="row spacer">
				<div class="col-xs-12 col-sm-12 col-md-8 col-md-offset-2 col-lg-8 col-lg-offset-2" id="game-holder">
					<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 spacer-1">
						<div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
							<div class="stat-box bg-grad-default">
								<h2>Isoulation Factor</h2>
								<p id="k_text"></p>
							</div>
						</div>
						<div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
							<div class="stat-box bg-grad-default">
								<h2>Infection Chance</h2>
								<p id="p_text"></p>
							</div>
						</div>
						<div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
							<div class="stat-box bg-grad-default">
								<h2>Population <br>Size</h2>
								<p id="populationSize"></p>
							</div>
						</div>
						<div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
							<div class="stat-box bg-grad-default">
								<h2>Run <br>Time</h2>
								<p id="runTime"></p>
							</div>
						</div>					
					</div>
					<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 spacer-1">
						<div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
							<div class="stat-box bg-grad-green">
								<h2>Healthy</h2>
								<p id="healthy_text"></p>
							</div>
						</div>
						<div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
							<div class="stat-box bg-grad-red">
								<h2>Infected</h2>
								<p id="infected_text"></p>
							</div>
						</div>
						<div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
							<div class="stat-box bg-grad-black">
								<h2>Dead</h2>
								<p id="dead_text"></p>
							</div>
						</div>
						<div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
							<div class="stat-box bg-grad-blue">
								<h2>Recovered</h2>
								<p id="recover_text"></p>
							</div>
						</div>					
					</div>
					
					<!-- The game-->
					<div id="game"></div>
					<!-- End - The game-->
					
					<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
						<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
							<div>
								<button class="round-button" onclick="return pauseGame();" id="pauseBtn" title="Pause Simulation"><i class="fa fa-pause fa-2x"></i></button>
								<button class="round-button " onclick="return playGame();" id="playBtn" title="Play Simulation" disabled><i class="fa fa-play fa-2x" ></i></button>
								<button class="round-button" onclick="return fullScreen();" id="fullScreenBtn" title="Show Full Screen"><i class="fa fa-arrows-alt fa-2x"></i></button>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row spacer">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 center">
					<h2 class="title"> Generation Graphs</h2>
				</div>
				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 center">
					<div id="stateGraph"></div>
					<p> State distribution over population per generation</p>
				</div>
				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 center">
					<div id="consensusGraph"></div>
					<p> Number of generations until consensus as a function of the population size</p>
				</div>
				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 center">
					<div id="populationSizeAvgConversionPerP"></div>
					<p> Avg consensus time as a function of the population size </p>
				</div>
				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 center">
					<div id="pValuePopulationVectorGraph"></div>
					<p>Avg number of generation that all population infected as a function of the infection chance </p>
				</div>
			</div>
			<div class="row spacer">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
					<h2 class="title center"> Research conclusions </h2>
					<p style="margin-left: 100px; font-size: 16pt;">
						We wish to answer the following questions using the simulator:
						<ul style="list-style-type:circle; margin-left: 100px">
							<li>How the population size (N) is affecting the averge convergece time?</li>
							<li>How the infection chance (p) is affecting the averge convergece time?</li>
							<li>How the isolation factor (k) is affecting the averge convergece time?</li>
							
						</ul>
					</p>
					
					<p style="margin-left: 100px; font-size: 12pt;">
						To answer these questions, we used a simple model based on the "game of life" calculation model. We implemented each agent to perform two things in each generation. 
						<br> First, randomly pick a location between the 8 nearby cells and itself and try to move to there. If another agent is located at this location then stay in the same location.
						<br> Second, if the agent is infected (red), look at each of the nearby cells. If an agent is allocated in them, change it's status to infected as well.
						<br> We repeat this process until all the population is infected. This whole process is repeated multiple times to get a good mean value reducing the stochastic noise of the system.
						<br> Afterwards, the averge values are calculated and the whole process starts with different population size. 
						<br> We repeat the simulation with varying population size, infection chance (p) and isolation factor (k) in ascending order.
						<br> The isolation factor is implemented by blocking the possible directions of infection represented by neighboring cells. Starting at the upper cell at k=1, moving in a clock-wise rotation, blocking more cells from the abilty to ifect.
						<br> For each k value a txt file is saved automatically summarizing the results.
						<br> An optional parameter L delaying the time when the isolation kicks in is also implemented
						<br> Finally, when the simulation is over the results are saved as a list of matrices of (population size, infection chance).
						<br><br> We also implemented, for future analysis which is beyond the scope of the exercise, possibilities of death and recovery that can be manipulated by the user.  
						<br><br> The two main objects of the simulation are 'grid' and 'population'. The grid serving as the environment for our the interactions of its misfortunate inhabitants.
						<br> Population object responsible for keeping track of the inhabitants and their changing locations and states which are crucial for the epidemic simulation.
						<br> We would also like to point out an algorithmic achievement in the implementation of the infection funciton.
						<br> In each iteration, next to be infected individuals are found with complexity of O(1) and are infected during the runtime of the same iteration.
						<br> In total the computational complexity sums to O(9*N) ~ O(N), where N is the population size, instead of being O(M^2), where M is the grid length. 
						<br> Assuming that M^2 >> N it is easy to see the benefit of such approach.
					</p>
					
					
					<p style="margin-left: 100px; font-size: 12pt;">
						Based on the data from the simulation, we used the min least squres method on the function familiy: <br><b>f(s,p) = a + b * s + c * p</b>. 
						<br> We picked this function familiy to get a fair approximation on one hand but a simple model on the other hand. Indeed, running the Python code on the results included <b><a href="data.zip">here</a></b> provides: 
						<br><br> 
						<ul style="list-style-type:circle; margin-left: 100px; font-size: 16pt;">
							<b>
							<li>k = 0 : 199.56 - 0.36 * s - 0.36 * p | R^2 = 0.023 <br><br><img src="img/fig_1.png" style="height: 400px;"><br> </li>
							<li>k = 1 : 243.43 - 0.92 * s - 0.98 * p | R^2 = 0.75<br><br><img src="img/fig_2.png" style="height: 400px;"><br> </li>
							<li>k = 2 : 307.52 - 1.15 * s - 1.27 * p | R^2 = 0.67<br><br><img src="img/fig_3.png" style="height: 400px;"><br> </li>
							<li>k = 3 : 267.78 - 1.05 * s - 1.01 * p | R^2 = 0.67<br><br><img src="img/fig_4.png" style="height: 400px;"><br> </li>
							<li>k = 4 : 307.52 - 1.15 * s - 1.27 * p | R^2 = 0.69<br><br><img src="img/fig_5.png" style="height: 400px;"><br> </li>
							<li>k = 5 : 323.55 - 1.16 * s - 1.34 * p | R^2 = 0.72<br><br><img src="img/fig_6.png" style="height: 400px;"><br> </li>
							<li>k = 6 : 439.48 - 1.60 * s - 1.99 * p | R^2 = 0.71<br><br><img src="img/fig_7.png" style="height: 400px;"><br> </li>
							<li>k = 7 : 627.76 - 2.26 * s - 3.07 * p | R^2 = 0.66<br><br><img src="img/fig_8.png" style="height: 400px;"><br> </li>
							</b>
						</ul>
						<br><br> In addition, we can understand how effective the isulation factor by computing the integral of each two functions. The results shown in the following graph:
						<br><br>
						<div class="row">
							<div class="col-lg-6 col-md-6 col-sm-12">
								<img src="img/k_summery.png" style="height: 400px;">
							</div>
							<div class="col-lg-6 col-md-6 col-sm-12">
								<img src="img/k_summery2.png" style="height: 400px;">
								<p>
									We fit the results with the function family: <b>f(k) = a + b * x + c * x ^ 2</b>,<br> getting: <b>f(k) = 78 - 49.5 * k + 19.8 * k ^ 2</b> with <b>R^2 = 0.963 </b>.
								</p>
							</div>
						</div>
						<br><br> We can conculde that the isulation factors is increasing the time taking the whole population to be infected because the graph is non-negative which indicates as isolation factor increasing the mean time for conversation is increasing as well.
						<br> By qualitative analysis of the two graphs above it is apparent that when at k equals 5 there is a significant change of the graphs behavior.
						<br> This leads us to the cautious conclusion that k=5 is the threshold isolation factor needed to control a epidemic in this simplified world.
						<br><br> As of the effect of the population size N, it easly seen from looking at runtime graphs with various initial parameters that not the sheer size but the density of the population has a key role in the infection rates. 
						<br> This phenomenon is expected and can be observed in the real world, where densely populated citites serve as outbreak hubs on a national level.
						<br> Observing the effect of the infection chance p on different sizes of population we noted that the convergece time increased in a roughly linear fashion and there wasn't any threshold infection we could point out, below the convergece times increased substantially.
						<br> It is worth noting that as expected L shortenes the convergece times, especially for high K's, making the isolation practically irrelevant when the L is large enough.
						<br><br>
										<div class="form-group">
											<label for="init_infected">The Python code for the min least squres method</label>
											<textarea class="form-control" id="init_infected" readonly rows="160">
import numpy as np
import scipy.linalg
from matplotlib import cm
from random import randint
import matplotlib.pyplot as plt
import scipy.optimize as optimize
from scipy.optimize import curve_fit
from mpl_toolkits.mplot3d import Axes3D
from sklearn.metrics import mean_squared_error, r2_score


class StablePlot:
    """
    Find the best curse regarding the the given function
    """

    fig_index = 1
    funcs = []

    def __init__(self,
                 data_path: str):
        self.p_values = []
        self.pop_sizes = []
        self.data = []
        with open(data_path, "r") as data_file:
            index = 0
            for line in data_file.readlines():
                if index == 0:
                    self.pop_sizes = [int(i.replace("population size = ", "")) for i in line.split(",")[1:-1]]
                    index += 1
                    continue
                items = line.split(",")[:-1]
                self.p_values.append(int(items[0]))
                self.data.append([int(i) for i in items[1:]])
                index += 1

    def fit_points(self):
        """
        find the best fitting
        :return: the params and save a file
        """
        x = []
        y = []
        z = []
        for p_index, p_value in enumerate(self.p_values):
            for pop_index, pop_size in enumerate(self.pop_sizes):
                x.append(p_value)
                y.append(pop_size)
                z.append(self.data[p_index][pop_index])
        data = np.c_[x, y, z]
        mn = np.min(data, axis=0)
        mx = np.max(data, axis=0)
        X, Y = np.meshgrid(np.linspace(mn[0], mx[0], 100), np.linspace(mn[1], mx[1], 100))
        XX = X.flatten()
        YY = Y.flatten()

        # best-fit linear plane
        A = np.c_[data[:, 0], data[:, 1], np.ones(data.shape[0])]
        C, _, _, _ = scipy.linalg.lstsq(A, data[:, 2])  # coefficients

        # evaluate it on grid
        Z = np.dot(np.c_[XX, YY, np.ones(XX.shape)], C).reshape(X.shape)

        XX = np.asarray(x)
        YY = np.asarray(y)
        z_pred = np.dot(np.c_[XX, YY, np.ones(XX.shape)], C).reshape(XX.shape)
        print("Params: {}".format(C))
        print("R^2 = {}".format(r2_score(np.asarray(z), z_pred)))

        StablePlot.funcs.append([C[0], C[1], C[2]])

        fig = plt.figure()
        ax = fig.gca(projection='3d')
        surf = ax.plot_surface(X, Y, Z, rstride=1, cstride=1, alpha=0.6, linewidth=0, antialiased=False, cmap=cm.coolwarm)
        ax.scatter(data[:, 0], data[:, 1], data[:, 2], c='black', s=5, alpha=0.5)
        plt.xlabel("P values")
        plt.ylabel("Population Size")
        ax.set_zlabel("Average Generation To Converge")
        ax.axis('equal')
        ax.axis('tight')
        # Add a color bar which maps values to colors.
        fig.colorbar(surf, shrink=0.5, aspect=5)
        # plt.show()
        plt.savefig("fig_{}.png".format(StablePlot.fig_index))
        StablePlot.fig_index += 1

    def calc_deltas_in_layers(self):
        deltas = []
        layers = []
        for i in range(StablePlot.fig_index - 1):
            layer_k = []
            for p_index, p_value in enumerate(self.p_values):
                for pop_index, pop_size in enumerate(self.pop_sizes):
                    layer_k.append(f(p_value, pop_size, StablePlot.funcs[i][0], StablePlot.funcs[i][1], StablePlot.funcs[i][2]))
            layers.append(layer_k)
        for i in range(StablePlot.fig_index - 2):
            deltas.append(round(sum(list_delta(layers[i + 1], layers[i])) / (len(layers[i]) * len(layers[i]))))

        fig = plt.figure()
        plt.plot([i for i in range(len(deltas))], deltas, linestyle='-', marker='o', color='b')
        plt.ylabel("Delta In Data Points (numerical integral)")
        plt.xlabel("K value")
        plt.savefig("k_summery.png")

    def calc_sum_deltas(self):
        deltas = []
        layers = []
        for i in range(StablePlot.fig_index - 1):
            layer_k = []
            for p_index, p_value in enumerate(self.p_values):
                for pop_index, pop_size in enumerate(self.pop_sizes):
                    layer_k.append(f(p_value, pop_size, StablePlot.funcs[i][0], StablePlot.funcs[i][1], StablePlot.funcs[i][2]))
            layers.append(layer_k)
        for i in range(1, StablePlot.fig_index - 1):
            deltas.append(round(sum(list_delta(layers[i], layers[0])) / (len(layers[i]) * len(layers[i]))))

        fig = plt.figure()
        ax = plt.subplot(111)
        x_vals = [i for i in range(len(deltas))]
        popt, pcov = curve_fit(square_func,
                               x_vals,
                               deltas)
        plt.plot(x_vals, deltas, linestyle='-', marker='o', color='r', label="results")
        plt.plot(x_vals, [square_func(i, popt[0], popt[1], popt[2]) for i in x_vals], linestyle='--', marker='^', color='black', label="approximation")
        print("f(k) = {} + {} * k + {} * k^2".format(popt[0], popt[1], popt[2]))
        print("r^2 = {}".format(r2_score(np.asarray([square_func(i, popt[0], popt[1], popt[2]) for i in x_vals]), np.asarray(deltas))))
        plt.ylabel("Surface Integral value")
        plt.xlabel("K value")
        ax.legend()
        plt.savefig("k_summery2.png")


def square_func(x: float,
                a: float,
                b: float,
                c: float) -> float:
    return a + b * x + c * x * x


def f(x, y, a, b, c):
    return a + b * x + c * y


def list_delta(arr1: list, arr2: list):
    return [arr1[i] - arr2[i] for i in range(len(arr1))]


if __name__ == '__main__':
    model = None
    for i in range(1, 9):
        model = StablePlot(r"C:\Users\user\Desktop\game_of_life_corona_k_eq_{}.txt".format(i))
        model.fit_points()
    model.calc_deltas_in_layers()
    model.calc_sum_deltas()
											</textarea>
										</div>
									</div>
								</div>
							</form>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div
</body>
</html>