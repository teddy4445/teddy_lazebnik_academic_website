<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Theodore (Teddy) Lazebnik</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Theodore (Teddy) Lazebnik personal website" name="description">
    <meta content="Teddy Lazebnik" name="author">
	<!-- css -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/teddy_style.css" rel="stylesheet">
	

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-154895667-1"></script>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-154895667-1');
	</script>
</head>

<body onload="init()">
	<div class="row">
		<div class="col-lg-2 col-md-2 col-sm-1">
		
		</div>
		<div class="col-lg-8 col-md-8 col-sm-10">
			<div class="header">
				<h1>
				Theodore (Teddy) Lazebnik
				</h1>
			</div>
			<div class="menu">
				<ul>
					<li><a href="../index.html"> Short Bio </a></li>
					<li><a href="../publications.html"> Publications </a></li>
					<li><a href="../students.html"> Students </a></li>
					<li><a href="../opensource.html"> Open Resources </a></li>
					<li><a href="../teaching.html"> Teaching </a></li>
					<li><a href="" class="active"> Generic Sementic Analysis Sample </a></li>
				</ul>
			</div>
			<div class="body">
				<div class="fluid-container">
					<div class="row">
					<div class="col-lg-12 col-md-12 col-sm-12">
						<div class="info">
							<h3> General Sementic Analysis </h3>
								<div id="train_panel">
									<p><b>Train Panel</b></p>
									<form style="text-align: left;">
										<div class="form-group">
											<label for="Sentences">Sentences</label>
											<input class="form-control" type="file" id="Sentences" placeholder="Sentences">
											<a target="_blank" class="btn btn-info" href="data/data.txt">Show Default Set</a>
										</div>
										<div class="form-group">
											<label for="Tags">Tags</label>
											<input class="form-control" type="file" id="Tags" placeholder="Tags">
											<a target="_blank" class="btn btn-info" href="data/tags.txt">Show Default Set</a>
										</div>
										<div class="form-group">
											<label for="StopWords">Stop Words</label>
											<input class="form-control" type="file" id="StopWords" placeholder="Stop Words">
											<a target="_blank" class="btn btn-info" href="data/sw.txt">Show Default Set</a>
										</div>
									</form>
									<button id="trainBtn" class="btn btn-primary btn-lg" onclick="train();" style="margin-top: 10px; margin-bottom: 10px;">Train</button>
									<p>Train may take up to few minutes...<br><br></p>									
									
									<form style="text-align: left;">
										<div class="form-group">
											<label for="ModelFile">Load Model File</label>
											<input class="form-control" type="file" id="ModelFile" placeholder="Model File">
											<a target="_blank" class="btn btn-info" href="data/model_2_tags.txt">Show Default Model</a>
										</div>
									</form>
									
								</div>
								
								<div id="inferance_panel" style="display: none">
									<p><b>Inferance Panel</b></p>
									<form style="text-align: left;">
										<div class="form-group">
											<label for="Sentence">Sentence</label>
											<input class="form-control" type="text" id="Sentence" placeholder="Check Sentence">
										</div>
										<div class="form-group">
											<label for="BestTag">Best Tag</label>
											<input class="form-control" type="text" id="BestTag" placeholder="" readonly>
										</div>
									</form>
									<button class="btn btn-primary btn-lg" onclick="run();" style="margin-top: 10px; margin-bottom: 10px;">Check</button>
									<div id="plot_container">
										
									</div>
									<form style="text-align: left;">
										<div class="form-group">
											<label for="CheckWord">Check Word</label>
											<input class="form-control" type="text" id="CheckWord" placeholder="Check Sentence">
										</div>
										<div class="form-group">
											<label for="BestTagWord">Best Tag</label>
											<input class="form-control" type="text" id="BestTagWord" placeholder="" readonly>
										</div>
									</form>
									<button class="btn btn-primary btn-lg" onclick="runWord();" style="margin-top: 10px; margin-bottom: 10px;">Check Word</button>
									<div id="plot_container_word">
										
									</div>
								</div>
						</div>
					</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<!-- Random image generator -->
	<script>
	google.charts.load('current', {packages: ['corechart', 'bar']});
	
	let data = null;
	let tags = null;
	let stopWords = null;
	let stopWordsListLower = null;
	let model = null;
	
	document.getElementById("trainBtn").disabled = true;
	
	function init()
	{
	  document.getElementById('Sentences').addEventListener('change', DataFile, false);
	  document.getElementById('Tags').addEventListener('change', TagFile, false);
	  document.getElementById('StopWords').addEventListener('change', StopWordsFile, false);
	  document.getElementById('ModelFile').addEventListener('change', ModelFileLoader, false);
	}

	function DataFile(event)
	{
	  const reader = new FileReader();
	  reader.onload = DataFileLoad;
	  reader.readAsText(event.target.files[0]);
	  console.log("Data file loaded");
	}

	function DataFileLoad(event)
	{
	  data = event.target.result;
	  openTrain();
	}

	function TagFile(event)
	{
	  const reader = new FileReader();
	  reader.onload = TagFileLoad;
	  reader.readAsText(event.target.files[0]);
	  console.log("Tags file loaded");
	}

	function TagFileLoad(event)
	{
	  tags = event.target.result;
	  openTrain();
	}

	function StopWordsFile(event)
	{
	  const reader = new FileReader();
	  reader.onload = StopWordsFileLoad;
	  reader.readAsText(event.target.files[0]);
	  console.log("StopWords file loaded");
	}

	function StopWordsFileLoad(event)
	{
	  stopWords = event.target.result;
	  openTrain();
	}

	function ModelFileLoader(event)
	{
	  const reader = new FileReader();
	  reader.onload = ModelFileLoaderLoad;
	  reader.readAsText(event.target.files[0]);
	  console.log("Model file loaded");
	}

	function ModelFileLoaderLoad(event)
	{
		stopWordsListLower = [];
		model = JSON.parse(event.target.result);
		document.getElementById("inferance_panel").style.display = "";
		document.getElementById("train_panel").style.display = "none";
	}
	
	function openTrain()
	{
		if (data != null && tags != null & stopWords != null)
		{
			document.getElementById("trainBtn").disabled = false;
		}
		else
		{
			document.getElementById("trainBtn").disabled = true;
		}
	}
	
	function runWord()
	{
		// get input 
		var input = document.getElementById("CheckWord").value.trim().toLowerCase();
		
		tagsFinalCount = new Object();
		if (input in model)
		{
			var tagsCounts = model[input];
			for (var tag in tagsCounts)
			{
				tagsFinalCount[tag] = tagsCounts[tag];
			}
		}
		else
		{
			alert("Word '" + input + "' is not in the model");
			return false;
		}
		// normalize ansewr again
		var tagsDist = NormalizeCountSpace(tagsFinalCount);
		// pick the bigget one and show on screen
		var maxTag = null;
		var maxScore = 0;
		var graphData = [];
		for (var tag in tagsDist)
		{
			if (tagsDist[tag] >= maxScore)
			{
				maxScore = tagsDist[tag];
				maxTag = tag;
			}
			graphData.push([tag, 100 * tagsDist[tag]]);
		}
		document.getElementById("BestTagWord").value = "Tag: " + maxTag + ", confidance: " + (Math.floor((10000 * maxScore))/100) + "%";
		// plot the distrebution as graph
		  var data = new google.visualization.DataTable();
		  data.addColumn('string', 'Tag');
		  data.addColumn('number', 'Confidance');

		  data.addRows(graphData);

		  var options = {
			title: 'Tags Distrebution',
			legend: 'none',
			hAxis: {
			  title: 'Tag'
			},
			vAxis: {
			  title: 'Confidance (%)',
			  ticks: [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100]
			}
		  };

		  var chart = new google.visualization.ColumnChart(document.getElementById('plot_container_word'));
		  chart.draw(data, options);
	}
	
	function run()
	{
		// get input 
		var input = document.getElementById("Sentence").value;
		// convert to the same standard
		var inputWords = FixSentence(input);
		
		// sum the values for each one
		var tagsFinalCount = [];
		var isFirstTime = true;
		for (var i = 0; i < inputWords.length; i++)
		{
			if (inputWords[i] in model)
			{
				// get all the possible tags 
				if (isFirstTime)
				{
					for (var tag in model[inputWords[i]])
					{
						tagsFinalCount[tag] = 0;
					}
					isFirstTime = false;
				}
				var tagsCounts = model[inputWords[i]];
				for (var tag in tagsCounts)
				{
					tagsFinalCount[tag] += tagsCounts[tag];
				}
			}
		}
		// normalize ansewr again
		var tagsDist = NormalizeCountSpace(tagsFinalCount);
		// pick the bigget one and show on screen
		var maxTag = null;
		var maxScore = 0;
		var graphData = [];
		for (var tag in tagsDist)
		{
			if (tagsDist[tag] >= maxScore)
			{
				maxScore = tagsDist[tag];
				maxTag = tag;
			}
			graphData.push([tag, 100 * tagsDist[tag]]);
		}
		document.getElementById("BestTag").value = "Tag: " + maxTag + ", confidance: " + (Math.floor((10000 * maxScore))/100) + "%";
		// plot the distrebution as graph
		  var data = new google.visualization.DataTable();
		  data.addColumn('string', 'Tag');
		  data.addColumn('number', 'Confidance');

		  data.addRows(graphData);

		  var options = {
			title: 'Tags Distrebution',
			legend: 'none',
			hAxis: {
			  title: 'Tag'
			},
			vAxis: {
			  title: 'Confidance (%)',
			  ticks: [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100]
			}
		  };

		  var chart = new google.visualization.ColumnChart(document.getElementById('plot_container'));
		  chart.draw(data, options);
	}
	
	function train()
	{
		// prepare data objects
		var dataSentences = data.split("\n");
		var tagsList = tags.split("\n");
		var stopWordsList = stopWords.split("\n");
		
		// check valid sizes
		if (dataSentences.length != tagsList.length)
		{
			alert("The number of samples and tags are not the same - abording train");
			return false;
		}
		
		document.getElementById("trainStatus").style.display = "";
		
		// make sure the stop words in the same format as the data we compare to
		stopWordsListLower = [];
		for (var i = 0; i < stopWordsList.length; i++)
		{
			stopWordsListLower.push(stopWordsList[i].trim().toLowerCase());
		}
		console.log("Stop Words Ready");
		
		var fixedData = FixData(dataSentences);
		
		console.log("Data is in right format");
		
		// build the space of each tag words
		var tagsSapces = new Object();
		// first, empty list to each tag
		for (var i = 0; i < tagsList.length; i++)
		{
			tagsSapces[tagsList[i].trim().toLowerCase()] = [];
		}
		// add words to each data to this tags spaces
		for (var tagIndex = 0; tagIndex < tagsList.length; tagIndex++)
		{
			for (var wordIndex = 0; wordIndex < fixedData[tagIndex].length; wordIndex++)
			{
				tagsSapces[tagsList[tagIndex].trim().toLowerCase()].push(fixedData[tagIndex][wordIndex]);
			}
		}
		console.log("Ready Tag list");
		// make each space a count space
		for (var tagItem in tagsSapces)
		{
			tagsSapces[tagItem] = CountSpace(tagsSapces[tagItem]);
		}
		console.log("Data as count space");
		
		// set the model
		model = reverseKeyValue(tagsSapces);
		console.log("Model is ready");
		// download it
		downloadasTextFile("model_" + Object.keys(tagsSapces).length + "_tags.txt", JSON.stringify(model));
		
		// update the GUI
		document.getElementById("inferance_panel").style.display = "";
		document.getElementById("train_panel").style.display = "none";
		console.log("Trian finished");
	}
	
	function reverseKeyValue(tagToWords)
	{
		// find all uniqe words and tags
		var allWords = [];
		var allTags = [];
		for(var tag in tagToWords) 
		{
			allTags.push(tag);
			for(var word in tagToWords[tag])			
			{
				if (!(word in allWords))
				{
					allWords.push(word);
				}
			}
		}
		
		// init answer but without weights 
		var answer = new Object();
		for (var wordIndex = 0; wordIndex < allWords.length; wordIndex++)
		{
			answer[allWords[wordIndex]] = new Object();
			for (var tagIndex = 0; tagIndex < allTags.length; tagIndex++)
			{
				answer[allWords[wordIndex]][allTags[tagIndex]] = 0;
			}
		}
		
		var countError = 0;
		
		// for each word, we wish to get the count for each tag
		for(var tag in tagToWords) 
		{
			allTags.push(tag);
			for(var word in tagToWords[tag])			
			{
				try
				{
					answer[word][tag] = tagToWords[tag][word];
				}
				catch (error)
				{
					countError += 1;
					console.log("Error #" + countError + " saying: " + error + ", at tag = " + tag + " & word = " + word);
				}
			}
		}
		
		return answer;
	}
	
	function CountSpace(repeatWords)
	{
		var counts = new Object();
		for (var i = 0; i < repeatWords.length; i++)
		{
			if (repeatWords[i] in counts)
			{
				counts[repeatWords[i]] += 1;
			}
			else
			{
				counts[repeatWords[i]] = 1;
			}
		}
		return counts;
	}
	
	function NormalizeCountSpace(countSpace)
	{
		// use L1 normalization
		var sum = 0;
		for(var key in countSpace) 
		{
			sum += countSpace[key];
		}
		
		var normalizedCounts = new Object();
		for(var key in countSpace) 
		{
			normalizedCounts[key] = countSpace[key] / sum;
		}
		return normalizedCounts;
	}
	
	function FixData(dataSentences)
	{
		// fix text //
		// remove double spaces, non letters 
		var fixedSentences = [];
		for (var i = 0; i < dataSentences.length; i++)
		{
			fixedSentences.push(FixSentence(dataSentences[i]));
		}
		return fixedSentences;
	}
	
	function FixSentence(sent)
	{
		// remove non-alphanumeric chars and keep spaces
		var answer = sent.trim().toLowerCase().replace(/[^0-9a-z ]/gi, ''); 
		// remove double spaces
		while (answer.includes("  "))
		{
			answer = answer.replace("  ", " ");
		}
		// get tokens 
		var answerWords = answer.split(" ");
		// remove stop words
		var answerFinalWords = [];
		for (var i = 0; i < answerWords.length; i++)
		{
			var isStopWord = false;
			for (var j = 0; j < stopWordsListLower.length; j++)
			{
				if (answerWords[i] == stopWordsListLower[j])
				{
					isStopWord = true;
					break;
				}
			}
			if (!isStopWord)
			{
				answerFinalWords.push(answerWords[i]);
			}
		}
		return answerFinalWords;
	}
	
	function downloadasTextFile(filename, text) {
		var element = document.createElement('a');
		element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
		element.setAttribute('download', filename);

		element.style.display = 'none';
		document.body.appendChild(element);

		element.click();

		document.body.removeChild(element);
	}
	</script>
</body>
</html>